package by.cniitu.virtualexhibition;

import java.sql.*;
import java.util.Arrays;
import java.util.List;

// TODO move it to other project
public class Main {

    static String getEui(String serialNumber){
        StringBuilder eui = new StringBuilder(Integer.toHexString(Integer.parseInt(serialNumber)));
        while(eui.length() < 16)
            eui.insert(0, 0);
        return eui.toString();
    }

    static Connection conn = null;

    static final long oneDay = 86400000L;
    static final long twoDays = 2 * oneDay;
    static final long threeDays = 3 * oneDay;
    static final long fourDays = 2 * twoDays;
    static final long fiveDays = 5 * oneDay;



    // the device is normal if it has at least one message in five days
    static boolean normalEui(String eui) throws SQLException {
        Statement statement = conn.createStatement();
        ResultSet resultSet = statement.executeQuery("select * from packet where eui = '" + eui + "' and mod_time > '2020-12-01' order by mod_time;");
        Date date = Date.valueOf("2020-12-01");
        while (resultSet.next()) {
            Date nextDate = resultSet.getDate("mod_time");
            if(nextDate.getTime() - date.getTime() > fiveDays){
                return false;
            }
            date = nextDate;
        }
        return true;
    }

    static boolean normalSerialNumber(String serialNumber) throws SQLException{
        return normalEui(getEui(serialNumber));
    }

    public static void main(String[] args) {

        try {
            String url = "jdbc:postgresql://localhost:5433/lora_3rd_part";
            conn = DriverManager.getConnection(url, "lora_user", "lora_user");

            System.out.println("Got it!");

            List<String> serialNumbers = Arrays.asList("0000145","0000290","0001082","0000381","0000334","0000249",
                    "0000655","0000311","0000314","0000969","0000148","0000170","0000190","0000985","0000463",
                    "0000270","0000954","0000424",
                    "0000352","0000866","0000359","0000640","0000644","0000413","0001004","0000133","0000761","0001084",
                    "0000730","0000289","0000960","0000316","0000257","0000237","0000250","0000134","0000651","0000171",
                    "0000689","0001062","0000388","0000694","0000131","0000348","0000764","0000165","0000765","0000498",
                    "0000135","0000661","0000232","0000464","0000117","0000407","0000414","0000461","0000209","0000335",
                    "0000387","0001079","0000423","0000406","0000708","0000239","0000271","0000485","0000279","0000401",
                    "0000373","0000409","0000094","0000872","0000400","0000275","0000193","0000096","0000287","0000130",
                    "0000304","0000215","0000280","0000331","0000399","0000088","0000322","0000405","0000101","0000368",
                    "0000691","0000403","0000374","0000734","0000189","0000353","0000743","0000340","0000380","0000299",
                    "0000285","0000302","0000327","0000379","0000741","0000085","0000396","0000205","0000699","0000377",
                    "0000111","0000582","0000906","0000759","0000207","0000364","0000223","0000369","0000703","0000386",
                    "0000325","0000293","0000296","0000397","0000425","0000682","0000562","0000390","0000355","0000395",
                    "0000338","0000347","0000370","0000272","0000263","0000605","0001088","0000690","0000281","0000389",
                    "0000623","0000825","0000265","0000785","0000664","0001069","0000151","0001030","0000140","0000242",
                    "0000698","0001067","0000358","0000391","0000127","0000811","0000837","0000884","0000609","0000931",
                    "0000827","0000686","0000212","0000696","0000997","0000988","0000933","0000938","0000857","0000341",
                    "0000093","0000648","0000774","0000646","0000124","0000910","0000693","0000343","0000654","0000831",
                    "0000354","0000153","0000812","0000417","0000489","0000946","0000912","0000073","0000650","0001031",
                    "0000922","0000300","0000589","0000631","0000683","0000877","0000990","0001085","0000880","0000449",
                    "0001059","0000174","0000581","0000955","0000298","0000687","0000977","0000072","0001087","0000776",
                    "0000613","0000913","0000618","0000318","0000305","0000454","0000528","0000873","0000057","0000668",
                    "0001007","0000722","0000308","0000762","0000799","0000781","0000419","0000939","0000726","0000841",
                    "0000962","0000636","0000804","0000422","0000797","0000282","0000944","0000998","0000410","0000908",
                    "0000850","0000801","0000725","0000889","0000921","0000735","0000506","0000567","0000680","0000256",
                    "0001100","0000188","0000911","0000836","0001078","0000259","0000824","0000115","0000900","0000846",
                    "0001023","0000312","0001060","0000060","0000839","0000760","0000966","0000838","0000809","0000168",
                    "0000844","0000548","0000393","0000503","0000959","0000233","0000848","0000942","0000109","0000192",
                    "0000860","0000902","0001029","0000230","0000914","0000894","0000714","0001042","0000953","0000227",
                    "0000586","0000106","0000695","0000858","0000700","0000790","0000876","0000555","0000991","0000727",
                    "0000058","0000559","0000440","0000901","0000652","0000159","0000453","0000488","0000662","0000252",
                    "0000986","0000950","0000952","0001010","0001000","0000639","0000958","0001048","0000792","0000934",
                    "0000478","0000436","0000918","0000772","0000813","0000598","0000481","0000929","0000056","0000070",
                    "0000062","0000659","0000583","0001037","0000533","0000569","0000443","0000375","0000865","0000898",
                    "0000479","0000926","0001061","0000816","0001011","0000967","0000868","0000493","0000600","0000940",
                    "0000182","0000221","0000283","0000068","0001028","0000162","0000477","0001056","0000472","0000255",
                    "0001022","0000434","0000957","0000810","0000888","0000823","0000822","0000770","0000881","0000426",
                    "0001043","0000777","0000474","0000480","0000541","0000382","0000819","0000328","0000446","0000462",
                    "0000578","0000949","0000976","0000672","0000800","0000723","0000236","0001017","0001024","0000220",
                    "0000786","0000545","0000433","0000437","0000572","0000372","0000179","0001046","0000863","0000852",
                    "0000637","0000628","0000731","0000795","0000333","0001077","0000210","0000943","0000497","0000451",
                    "0000724","0000484","0001063","0000482","0000674","0000814","0000324","0000181","0000468","0000496",
                    "0001076","0000465","0001005","0000633","0000535","0000365","0000486","0000763","0000961","0000849",
                    "0000444","0000495","0000452","0000782","0000469","0000490","0000980","0000717","0000665","0000903",
                    "0000993","0000553","0000089","0001003","0000521","0000517","0000524","0000542","0001089","0000539",
                    "0000981","0000712","0001018","0001013","0000803","0000500","0000769","0001064","0000526","0000757",
                    "0000862","0000634","0000630","0000856","0000778","0000456","0000361","0000448","0000595","0001070",
                    "0001008","0000214","0000558","0000999","0001066","0000491","0000855","0000487","0001040","0000638",
                    "0000530","0000438","0000515","0000457","0000196","0000538","0000467","0000450","0000206","0000565",
                    "0000471","0000766","0000499","0001021","0000829","0000427","0000832","0000602","0000513","0000435",
                    "0001065","0000494","0000547","0001019","0000351","0000512","0001036","0000492","0001025","0000755",
                    "0000626","0000504","0000675","0000729","0000560","0000624","0000826","0000540","0000754","0000384",
                    "0001009","0000224","0001073","0000745","0001052","0000817","0000621","0000520","0000571","0000815",
                    "0000136","0000245","0000585","0000751","0000647","0000794","0000120","0000713","0000748","0000326",
                    "0000660","0000692","0000532","0000728","0001047","0000614","0000607","0001001","0000635","0000199",
                    "0000746","0000688","0000243","0000629","0000152","0000197","0000534","0000676","0000996","0000951",
                    "0000756","0000447","0000670","0000861","0000909","0001058","0001045","0000983","0000666","0001006",
                    "0000502","0000166","0001068","0000603","0000685","0000620","0000869","0001049","0000508","0000557",
                    "0000821","0000617","0001039","0000268","0000789","0000920","0000554","0000501","0000678","0000161",
                    "0000733","0000802","0000740","0000871","0000715","0000552","0000982","0000828","0000556","0000883",
                    "0000132","0000203","0001051","0001054","0000258","0000590","0001074","0000158","0000156","0000549",
                    "0000719","0000367","0001057","0000907","0000066","0000362","0000150","0000546","0000964","0000459",
                    "0000394","0000974","0000887","0000577","0000835","0000599","0001081","0000736","0000775","0000121",
                    "0000732","0000805","0000658","0000069","0000753","0001012","0000505","0000074","0000543","0000941",
                    "0000796","0000859","0000616","0000783","0000758","0000720","0000261","0000897","0000611","0000820",
                    "0000673","0000742","0000455","0000886","0000194","0000681","0000667","0000716","0000677","0000378",
                    "0000905","0000744","0000091","0001035","0000483","0000970","0000923","0000721","0000201","0000885",
                    "0000510","0000509","0001071","0000575","0000537","0000108","0000711","0001080","0000254","0001034",
                    "0001032","0000129","0000079","0000551","0000081","0001020","0000323","0000842","0000222","0000739",
                    "0000684","0000718","0000383","0001083","0000779","0000421","0000516","0000707","0000346","0000870",
                    "0000704","0000360","0000580","0000247","0000843","0000653","0000806","0000987","0000972","0000641",
                    "0000336","0000288","0000663","0000550","0000845","0000415","0001075","0000971","0000356","0000376",
                    "0000544","0000867","0000612","0001072","0000570","0000137","0000519","0000669","0000936","0000916",
                    "0000251","0000466","0000945","0001002","0000564","0000807","0000527","0000798","0000144","0000956",
                    "0000771","0000321","0001044","0000701","0000105","0000606","0000126","0000200","0000319","0000968",
                    "0000183","0000078","0000928","0000191","0000149","0000398","0000470","0000110","0000345","0000584",
                    "0000104","0000531","0000874","0000313","0000172","0000350","0000264","0000061","0000076","0000385",
                    "0000608","0000143","0000114","0000791","0000229","0000173","0000315","0000697","0000392","0000301",
                    "0000095","0000917","0000071","0000113","0000059","0000075","0000180","0000103","0000579","0000768",
                    "0000077","0000339","0000891","0000706","0000656","0000097","0000610","0000830","0000979","0000198",
                    "0000896","0000187","0000185","0000573","0000273","0000118","0000363","0000278","0000142","0000157",
                    "0000622","0000925","0000090","0000092","0000291","0000899","0000184","0000266","0000086","0000211",
                    "0000160","0000924","0001027","0000879","0000840","0000244","0000155","0000141","0000235","0000240",
                    "0000225","0000927","0000309","0000460","0000267","0000645","0000947","0000965","0000937","0000218",
                    "0000895","0000818","0001041","0000615","0000176","0000773","0000178","0000119","0000246","0001016",
                    "0000563","0000344","0000213","0000522","0000851","0000864","0000175","0001055","0000854","0000975",
                    "0000904","0000138","0000112","0000992","0000566","0000893","0000511","0000274","0000286","0000525",
                    "0000847","0000523","0000878","0000593","0000139","0000625","0000164","0000107","0000529","0000276",
                    "0000780","0000408","0000643","0000994","0000411","0000657","0000642","0000418","0000919","0000366",
                    "0000705","0000710","0000087","0000592","0000978","0000915","0000445","0001038","0000750","0000793",
                    "0001050","0000808","0000332","0001014","0000752","0000930","0000357","0000320","0000253","0000067",
                    "0000349");

            for(String serialNumber: serialNumbers){
                boolean normal = normalSerialNumber(serialNumber);
                if(!normal) {
                    System.out.println("normalSerialNumber(" + serialNumber + ") = false");
                }
            }


        } catch (SQLException e) {
            throw new Error("Problem", e);
        } finally {
            try {
                if (conn != null) {
                    conn.close();
                }
            } catch (SQLException ex) {
                System.out.println(ex.getMessage());
            }
        }

    }

}
